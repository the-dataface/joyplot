<!DOCTYPE html>
<html>
<head>
<link href="https://fonts.googleapis.com/css?family=Mada:300,500,700" rel="stylesheet">
<style>

svg {
    display: block;
    margin: 0 auto;
    font-family: 'Mada';
    font-weight: 300;
}

.axis .domain {
    display: none;
}

.axis--x text, .axis--y text{
    fill: #999;
}

.axis--x line {
    stroke: #777;
    stroke-width: .1;
}

.axis--name .tick line {
    display: none;
}

.axis--name text {
    font-size: 12px;
    fill: #777;
}

.axis--name .tick:nth-child(odd) text {
    fill: #222;
}

.line {
    fill: none;;
}

.name:nth-child(odd) .line{
    fill: none;
}

.area {
    opacity:.6;
}

.name:nth-child(odd) .area {
    opacity:.6;
}
.overlay {
  fill: none;
  pointer-events: all;
}

.focus circle {
  fill: none;
  stroke: grey;
}

.bolded-text#mentions{
  font-weight: 700;
  font-size: 20px;
  baseline-shift: -44%;
}

.bolded-text#date{
  font-weight: 700;
  font-size: 20px;
  baseline-shift: -21%;
}

.sub-text {
  font-weight: 300;
  baseline-shift: sub;
}

</style>
</head>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
//good colors - #448cab and #5ca3c1

var margin = { top: 30, right: 200, bottom: 100, left: 300 },
    width = 1000 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;

// Percent two area charts can overlap
var overlap = 2;

//create svg with margins
var svg = d3.select('body')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

var x = function(d) { return d.date; };
var xScale = d3.scaleTime().range([0, width]);
var xValue = function(d) { return xScale(x(d)); };
var xAxis = d3.axisBottom(xScale).tickFormat(d3.timeFormat("%b")).tickArguments([d3.timeMonth.every(1)]);

var y = function(d) { return d.mentions; };
var yScale = d3.scaleLinear();
var yValue = function(d) { return yScale(y(d)); };

var nameCalc = function(d) { return d.key; };
var nameScale = d3.scaleBand().range([0, height]);
var nameValue = function(d) { return nameScale(nameCalc(d)); };
var nameAxis = d3.axisLeft(nameScale);

var colors = ["rgb(75,0,130)","rgb(138,43,226","rgb(147,112,219)","rgb(218,112,214)","rgb(221,160,221)",
              "rgb(216,191,216)","rgb(255,228,225)","rgb(255,160,122)","rgb(240,128,128)",
              "rgb(255,99,71)","rgb(220,20,60)","rgb(139,0,0)"];
var meanCalc = function(d) {return d.mean; };

//hey

var area = d3.area()
             .x(xValue)
             .y1(yValue);

var line = area.lineY1();

var parseTime = d3.timeParse("%m/%d/%Y");
var timeFormat = d3.timeFormat("%B %e");
var bisectDate = d3.bisector(function(d) { return d}).left;

var rowConverter = function(d) {
    return {
        name: d.names,
        date: parseTime(d.date),
        mentions: +d.sentences
    };
}

d3.csv('mediacloud-sentence-counts.csv', rowConverter, function(error, dataset) {
    if (error) throw error;

    // Sort by time
    dataset.sort(function(a, b) { return a.date - b.date; });

    var data = d3.nest()
        .key(function(d) { return d.name; })
        .entries(dataset);

    function findPeakTime(d) {
        for (i in d) {
          var topic_values = d[i].values;
          var max_index = d3.scan(topic_values, function(a, b) {return y(b) - y(a)});
          var peakTime = x(topic_values[max_index]);
          d[i].peakTime = peakTime;
        }
    };
    findPeakTime(data);

    data.sort(function(a, b) { return a.peakTime - b.peakTime;});

    function findAverageMentions(d) {
        for (i in d) {
          var topic_values = d[i].values;
          var mean = d3.mean(topic_values, function(a) {return y(a)});
          d[i].mean = mean;
        }
    }
    findAverageMentions(data);


    //var max_mentions = d3.max(dataset, function(d) {return d.mentions;});
    //var yAxis = d3.axisLeft(yScale).tickValues([max_mentions / 3, max_mentions * (2 / 3), max_mentions]);

    xScale.domain(d3.extent(dataset, x));
    nameScale.domain(data.map(function(d) { return d.key; }));

    max_mean = d3.max(data, function(d) {return d.mean});
    mean_threshold = max_mean / 2
    //rethink whether domain should start at 0 below
    var lowerMeanScale = d3.scaleLinear()
                           .domain([0, mean_threshold])
                           .interpolate(d3.interpolateHcl)
                           .range([d3.rgb('#3182bd'), d3.rgb('#deebf7')]);

    var upperMeanScale = d3.scaleLinear()
                           .domain([mean_threshold, max_mean])
                           .interpolate(d3.interpolateHcl)
                           .range([d3.rgb('#fee6ce'), d3.rgb('#e6550d')]);

    var areaChartHeight = (1 + overlap) * (height / nameScale.domain().length);

    yScale.domain([0, d3.max(dataset, function(d) {
            return d.mentions;
          })])
          .range([areaChartHeight, 0]);

    area.y0(yScale(0));

    var xAxisTransform = height + (overlap * (height / nameScale.domain().length));
    var xAxis2Transform = height / nameScale.domain().length;
    var yAxisTransform = overlap * (height / nameScale.domain().length);

    var gName = svg.append('g')
            .attr('class', 'names')
            .selectAll('.name')
            .data(data)
            .enter()
            .append('g')
            .attr('class', function(d) { return 'name name--' + d.key; })
            .attr('transform', function(d) {
                var ty = nameValue(d);
                return 'translate(0,' + ty + ')';
            });

    //gName.append('g')
         //.attr('class', 'axis axis--y')
         //.call(yAxis);

    gName.append('path')
        .attr('class', 'area')
        .datum(function(d) { return d.values; })
        .attr('d', area)
        .style('fill', function(d) {
           var mean = d3.mean(d, function(a) {return y(a)});
           if (mean < mean_threshold) {
             return lowerMeanScale(mean);
           } else {
             return upperMeanScale(mean);
           }
        });

    gName.append('path')
        .attr('class', 'line')
        .datum(function(d) { return d.values; })
        .attr('d', line)
        .style('stroke', function(d) {
           var mean = d3.mean(d, function(a) {return y(a)});
           if (mean < mean_threshold) {
             return lowerMeanScale(mean);
           } else {
             return upperMeanScale(mean);
           }
        });

    var focus = gName.append("g")
        .attr("class", "focus")
        .attr("id", function(d) {
          return d.key;
        })
        .style("display", "none");

    focus.append("circle")
        .attr("r", 4.5);

    focus.append("rect")
         .attr("class", "mentions")
         .attr("width", "0px")
         .attr("height", "0px")
         .attr("fill", "white")
         .attr("opacity", 1)
         .attr("pointer-events", "none")
         .attr("x", 9)
         .attr("y", -10)
         .attr("stroke-width", ".5px")
         .attr("stroke", "grey");

    focus.append("text")
        .attr("class", "bolded-text")
        .attr("id", "mentions")
        .attr("x", 11)
        .attr("dy", ".35em");

    focus.append("text")
        .attr("class", "sub-text")
        .attr("id", "after-mentions")
        .attr("x", 30)
        .attr("dy", ".35em")
        .text(" media mentions");

    focus.append("text")
        .attr("class", "sub-text")
        .attr("id", "before-date")
        .attr("x", 11)
        .attr("dy", "1.5em")
        .text("during the week of ");

    focus.append("text")
        .attr("class", "bolded-text")
        .attr("id", "date")
        .attr("x", 133)
        .attr("dy", "1.5em");

    gName.append("rect")
        .attr("class", "overlay")
        .attr("width", width)
        .attr("height", height)
        .on("mouseover", function() { focus.style("display", null); })
        .on("mouseout", function() { focus.style("display", "none"); })
        .on("mousemove", function(d) {
          d3.selectAll("g.focus")
            .style("display", "none")
            .filter(function() {
              var key = d.key;
              if (d3.select(this).attr("id") == key) {
                return true;
              } else {
                return false;
              }
            })
            .style("display", null);

          var mouseCoordinates = d3.mouse(this);
          var mouseX = mouseCoordinates[0];
          var mouseY = mouseCoordinates[1];
          mousemove(d.values, mouseX, mouseY);
        });

    function mousemove(data, mouseX, mouseY) {
      //find x value of mouse
      var x0 = xScale.invert(mouseX);
      //array of dates
      var date_array = [];
      for (i in data) {
        date_array.push(data[i].date);
      }

      var i = bisectDate(date_array, x0);

      var d0 = data[i - 1];
      var d1 = data[i];
      var d = x0 - d0.date > d1.date - x0 ? d1 : d0;
      focus.attr("transform", "translate(" + xScale(d.date) + "," + yScale(d.mentions) + ")");
      focus.select("#mentions").text(d.mentions);
      focus.select("#date").text(timeFormat(d.date));

      var xValues = textXValues();
      var afterMentionsXValue = xValues[0];
      var dateXValue = xValues[1];
      focus.select("#after-mentions").attr("x", afterMentionsXValue);
      focus.select("#date").attr("x", dateXValue);

      var rectWidthHeight = textBoxWidthHeight();
      var rectWidth = rectWidthHeight[0];
      var rectHeight = rectWidthHeight[1];
      focus.select("rect.mentions").attr("width", rectWidth).attr("height", rectHeight);
    }

    var textBoxWidthHeight = function() {

      var mentionsBBox = focus.select("#mentions").node().getBBox();
      var heightMentions = mentionsBBox.height;

      var beforeDateBBox = focus.select("#before-date").node().getBBox();
      var widthBeforeDate = beforeDateBBox.width;

      var dateBBox = focus.select("#date").node().getBBox();
      var widthDate = dateBBox.width;
      var heightDate = dateBBox.height;

      var heightPadding = 8;
      var widthPadding = 10;
      var totalWidth = widthBeforeDate + widthDate + widthPadding;
      var totalHeight = heightDate + heightMentions + heightPadding;

      var heightWidthArray = [totalWidth, totalHeight];
      return heightWidthArray;

    }

    var textXValues = function() {

      var mentionsBBox = focus.select("#mentions").node().getBBox();
      var widthMentions = mentionsBBox.width;

      var beforeDateBBox = focus.select("#before-date").node().getBBox();
      var widthBeforeDate = beforeDateBBox.width;

      var padding = 15;
      var mentionsXValue = widthMentions + padding;
      var dateXValue = widthBeforeDate + padding;

      var textXValuesArray = [mentionsXValue, dateXValue];
      return textXValuesArray;
    }

    svg.append('g')
       .attr('class', 'axis axis--x')
       .attr('transform', 'translate(0,' + xAxisTransform + ')')
       .call(xAxis);

    svg.append('g')
       .attr('class', 'axis axis--x2')
       .attr('transform', 'translate(0,' + xAxis2Transform + ')')
       .call(xAxis);

    svg.append('g')
       .attr('class', 'axis axis--name')
       .attr('transform', 'translate(0,' + yAxisTransform + ')')
       .call(nameAxis);


});

</script>
</body>
</html>
